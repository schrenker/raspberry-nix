---
apiVersion: admissionregistration.k8s.io/v1
kind: ValidatingAdmissionPolicy
metadata:
  name: enforce-resource-definition
spec:
  matchConstraints:
    resourceRules:
      - apiGroups: [""]
        apiVersions: ["v1"]
        operations: ["CREATE", "UPDATE"]
        resources: ["pods"]
      - apiGroups: ["apps"]
        apiVersions: ["v1"]
        operations: ["CREATE", "UPDATE"]
        resources: ["deployments", "statefulsets", "daemonsets"]
      - apiGroups: ["batch"]
        apiVersions: ["v1"]
        operations: ["CREATE", "UPDATE"]
        resources: ["jobs", "cronjobs"]
  failurePolicy: Fail
  validations:
    - expression: |
        (has(object.spec.template) ? object.spec.template.spec.containers : object.spec.containers).all(container,
          has(container.resources) &&
          has(container.resources.requests) &&
          has(container.resources.requests.cpu)
        )
      message: "All containers must specify CPU requests."

    - expression: |
        (has(object.spec.template) ? object.spec.template.spec.containers : object.spec.containers).all(container,
          has(container.resources) &&
          has(container.resources.requests) &&
          has(container.resources.requests.memory)
        )
      message: "All containers must specify memory requests."

    - expression: |
        (has(object.spec.template) ? object.spec.template.spec.containers : object.spec.containers).all(container,
          has(container.resources) &&
          has(container.resources.limits) &&
          has(container.resources.limits.memory)
        )
      message: "All containers must specify memory limits."

    - expression: |
        (has(object.spec.template) ? object.spec.template.spec.containers : object.spec.containers).all(container,
          quantity(container.resources.requests.memory) == quantity(container.resources.limits.memory)
        )
      message: "Memory requests must be equal to memory limits for all containers."
